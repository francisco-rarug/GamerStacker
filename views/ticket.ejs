<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito y Finalizar Compra</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script> <!-- Para generar PDF -->
    <link rel="stylesheet" href="./carrito.css"> <!-- Tu archivo CSS -->
</head>
<body>
    <h1>Carrito de Compras</h1>

    <ul id="productos-lista"></ul>

    <button id="finalizar">Finalizar Compra</button>

    <div id="modal-finalizar" class="modal">
        <div class="modal-content">
            <span id="close-finalizar" class="close">&times;</span>
            <h2>Resumen de Compra</h2>
            <ul id="lista-productos-finalizar"></ul>
            <button id="descargar-ticket">Descargar Ticket</button>
        </div>
    </div>

    <script>
        // Reutilizamos las funciones que definiste en tu archivo JS.
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-AR', {
                style: 'currency',
                currency: 'ARS',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function cargarCarrito() {
            let productosCarrito = JSON.parse(localStorage.getItem('carrito')) || [];
            const listaProductos = document.getElementById('productos-lista');
            listaProductos.innerHTML = '';

            let total = 0;

            if (productosCarrito.length === 0) {
                listaProductos.innerHTML = '<li>El carrito está vacío</li>';
            } else {
                productosCarrito.forEach((producto, index) => {
                    const li = document.createElement('li');
                    total += producto.precio;

                    li.innerHTML = `
                        <img src="${producto.img}" alt="${producto.nombre}" width="50" height="50"> 
                        <strong>${producto.nombre}</strong> - ${formatCurrency(producto.precio)} (x${producto.cantidad})
                        <button class="bin-button" data-index="${index}">Eliminar</button>
                    `;
                    listaProductos.appendChild(li);
                });

                const lineaHorizontal = document.createElement('hr');
                const totalElement = document.createElement('p');
                totalElement.innerHTML = `<strong class="precio">Total: ${formatCurrency(total)}</strong>`;

                listaProductos.appendChild(lineaHorizontal);
                listaProductos.appendChild(totalElement);
            }

            agregarEventosEliminar();
        }

        function agregarEventosEliminar() {
            document.querySelectorAll('.bin-button').forEach((boton) => {
                boton.addEventListener('click', (e) => {
                    const index = e.target.closest('.bin-button').dataset.index;
                    eliminarProducto(index);
                });
            });
        }

        function eliminarProducto(index) {
            let productosCarrito = JSON.parse(localStorage.getItem('carrito')) || [];

            if (productosCarrito[index].cantidad > 1) {
                productosCarrito[index].cantidad -= 1;
                productosCarrito[index].precio -= productosCarrito[index].precioOriginal;
            } else {
                productosCarrito.splice(index, 1);
            }

            localStorage.setItem('carrito', JSON.stringify(productosCarrito));
            cargarCarrito();
        }

        function cargarProductosFinalizar() {
            let productosCarrito = JSON.parse(localStorage.getItem('carrito')) || [];
            const listaProductosFinalizar = document.getElementById('lista-productos-finalizar');
            listaProductosFinalizar.innerHTML = '';

            let total = 0;

            productosCarrito.forEach(producto => {
                const li = document.createElement('li');
                total += producto.precio;
                li.innerHTML = `<strong>${producto.nombre}</strong> - ${formatCurrency(producto.precio)} (x${producto.cantidad})`;
                listaProductosFinalizar.appendChild(li);
            });

            const lineaHorizontal = document.createElement('hr');
            const totalElement = document.createElement('p');
            totalElement.innerHTML = `<strong>Total: ${formatCurrency(total)}</strong>`;

            listaProductosFinalizar.appendChild(lineaHorizontal);
            listaProductosFinalizar.appendChild(totalElement);
        }

        function generarPDFTicket() {
            let productosCarrito = JSON.parse(localStorage.getItem('carrito')) || [];

            const { jsPDF } = window.jspdf;
            let doc = new jsPDF();

            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Ticket de Compra', 10, 10);

            doc.setFontSize(12);
            let posicionY = 20;

            productosCarrito.forEach(producto => {
                doc.text(`Producto: ${producto.nombre}`, 10, posicionY);
                doc.text(`Cantidad: ${producto.cantidad}`, 10, posicionY + 5);
                doc.text(`Precio: ${formatCurrency(producto.precioOriginal)}`, 10, posicionY + 10);
                posicionY += 20;
            });

            const total = productosCarrito.reduce((acc, producto) => acc + producto.precio, 0);
            doc.text('-------------------------', 10, posicionY);
            doc.text(`Total: ${formatCurrency(total)}`, 10, posicionY + 10);

            doc.save('ticket_compra.pdf');
        }

        const finalizarBtn = document.getElementById("finalizar");
        finalizarBtn.addEventListener("click", () => {
            let productosCarrito = JSON.parse(localStorage.getItem('carrito')) || [];

            if (productosCarrito.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Atención',
                    text: 'Por favor, agrega productos al carrito antes de finalizar la compra.',
                    confirmButtonText: 'Aceptar',
                });
                return;
            }

            cargarProductosFinalizar();

            const modalFinalizar = document.getElementById("modal-finalizar");
            const modalContent = modalFinalizar.querySelector('.modal-content');

            modalFinalizar.style.display = "block";
            document.body.classList.add("no-scroll");

            setTimeout(() => {
                modalContent.classList.add("show");
            }, 10);
        });

        const descargarBtn = document.getElementById("descargar-ticket");
        descargarBtn.addEventListener("click", () => {
            generarPDFTicket();
        });

        const closeModal = document.getElementById("close-finalizar");
        closeModal.addEventListener("click", () => {
            const modalFinalizar = document.getElementById("modal-finalizar");
            const modalContent = modalFinalizar.querySelector('.modal-content');

            modalContent.classList.remove("show");
            setTimeout(() => {
                modalFinalizar.style.display = "none";
                document.body.classList.remove("no-scroll");
            }, 300);
        });

        window.addEventListener("click", (event) => {
            const modalFinalizar = document.getElementById("modal-finalizar");
            if (event.target === modalFinalizar) {
                const modalContent = modalFinalizar.querySelector('.modal-content');
                modalContent.classList.remove("show");
                setTimeout(() => {
                    modalFinalizar.style.display = "none";
                    document.body.classList.remove("no-scroll");
                }, 300);
            }
        });

        // Cargar el carrito al iniciar la página
        cargarCarrito();
    </script>
</body>
</html>
